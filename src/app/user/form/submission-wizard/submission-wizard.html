<!-- En-t√™te style "document" -->
<section class="mb-6 rounded-xl border bg-white overflow-hidden">
  <div class="h-1.5 w-full bg-green-600"></div>
  <div class="px-5 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="assets/logo.png" alt="FPBG" class="h-10 w-auto">
      <span class="inline-flex items-center rounded-full bg-green-100 text-green-700 px-3 py-1 text-xs font-medium">
        Mod√®le de Note Conceptuelle ‚Äî FPBG
      </span>
    </div>
    <div class="text-xs text-slate-500">Maximum 5 pages (hors annexes)</div>
  </div>
  <div class="px-5 pb-5">
    <h1 class="text-center text-xl sm:text-2xl font-semibold">APPEL √Ä PROJET OBLIGATIONS BLEUES FPBG</h1>
  </div>
</section>

<!-- Layout 3 colonnes -->
<div class="w-full grid gap-4 lg:gap-6
     grid-cols-1
     lg:grid-cols-[minmax(240px,27%)_1fr_minmax(280px,28%)]
     xl:grid-cols-[minmax(260px,26%)_1fr_minmax(340px,28%)]">

  <!-- ===== Sidebar √©tapes ===== -->
  <aside class="self-start sticky top-4 h-max rounded-xl border p-5 bg-white">
    <div class="text-xs text-gray-600 mb-3">progression</div>
    <div class="w-full bg-gray-100 rounded-full h-2 mb-4">
      <div class="h-2 rounded-full bg-green-600" [style.width.%]="progress()"></div>
    </div>

    <ol class="space-y-1 text-sm">
      <li *ngFor="let t of steps; let i = index; trackBy: trackByIndex">
        <button type="button"
                class="w-full text-left px-3 py-2 rounded-lg transition"
                [ngClass]="i === current() ? 'bg-green-600 text-white' : 'hover:bg-green-50'"
                (click)="goTo(i)">
          {{ i+1 }}. {{ t }}
        </button>
      </li>
    </ol>

    <div class="mt-4 flex gap-2">
      <button class="px-3 py-2 rounded-md border hover:bg-slate-50" (click)="prev()" [disabled]="current()===0">retour</button>
      <button class="px-3 py-2 rounded-md bg-green-600 text-white hover:bg-green-700"
              (click)="next()" [disabled]="current() === steps.length-1 || !canGoNext()">
        suivant
      </button>
    </div>
  </aside>

  <!-- ===== Colonne formulaire ===== -->
  <section class="space-y-6">

    <!-- 1) Proposition de projet -->
    <div *ngIf="current()===0" class="rounded-xl border bg-white p-5 md:p-6">
      <h2 class="text-lg font-semibold mb-3">Proposition de Projet</h2>
      <form [formGroup]="stepProp" class="grid gap-5">
        <div class="grid gap-1">
          <label class="text-sm font-medium text-gray-700">Titre du projet</label>
          <input class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm
                      placeholder:text-gray-400 outline-none focus:border-green-600 focus:ring-4 focus:ring-green-100"
                 formControlName="title" maxlength="120" placeholder="Ex : Restauration des berges de la rivi√®re X">
          <div class="text-xs text-gray-500 text-right">{{ (stepProp.get('title')?.value || '').length }}/120</div>
        </div>

        <!-- Domaines (checklist) -->
        <div class="grid gap-2">
          <label class="text-sm font-medium text-gray-700">Domaines d‚Äôintervention (s√©lectionnez un ou plusieurs)</label>
          <div class="grid sm:grid-cols-2 gap-2">
            <label *ngFor="let d of domainesOptions; trackBy: trackByIndex"
                   class="inline-flex items-center gap-2 rounded-lg border px-3 py-2">
              <input
                type="checkbox"
                [checked]="hasDomaine(d)"
                (change)="onDomaineToggle(d, $event)"
              />

              <span class="text-sm">{{ d }}</span>
            </label>
          </div>
        </div>

        <div class="grid gap-1">
          <label class="text-sm font-medium text-gray-700">Lieu d'ex√©cution & groupe cible (‚â§ 200 mots)</label>
          <textarea rows="3"
                    class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm
                           placeholder:text-gray-400 outline-none focus:border-green-600 focus:ring-4 focus:ring-green-100"
                    formControlName="locationAndTarget"></textarea>
          <div class="text-xs text-red-600" *ngIf="stepProp.get('locationAndTarget')?.errors?.['wordLimit']">
            Max 200 mots (actuel : {{ stepProp.get('locationAndTarget')?.errors?.['wordLimit']?.actual }})
          </div>
        </div>

        <div class="grid gap-1">
          <label class="text-sm font-medium text-gray-700">Contexte & justification (‚â§ 500 mots)</label>
          <textarea rows="6"
                    class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm
                           placeholder:text-gray-400 outline-none focus:border-green-600 focus:ring-4 focus:ring-green-100"
                    formControlName="contextJustification"></textarea>
          <div class="text-xs text-red-600" *ngIf="stepProp.get('contextJustification')?.errors?.['wordLimit']">
            Max 500 mots (actuel : {{ stepProp.get('contextJustification')?.errors?.['wordLimit']?.actual }})
          </div>
        </div>
      </form>
    </div>

    <!-- 2) Objectifs & r√©sultats -->
    <div *ngIf="current()===1" class="rounded-xl border bg-white p-5 md:p-6">
      <h2 class="text-lg font-semibold mb-4">Objectifs du projet & R√©sultats</h2>
      <form [formGroup]="stepObj" class="grid gap-5">
        <div class="grid gap-1">
          <label class="text-sm font-medium text-gray-700">Objectifs (‚â§ 200 mots)</label>
          <textarea rows="4" class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                    formControlName="objectives" placeholder="Formulez des objectifs SMART‚Ä¶"></textarea>
          <div class="text-xs text-red-600" *ngIf="stepObj.get('objectives')?.errors?.['wordLimit']">
            Max 200 mots (actuel : {{ stepObj.get('objectives')?.errors?.['wordLimit']?.actual }})
          </div>
        </div>

        <div class="grid gap-1">
          <label class="text-sm font-medium text-gray-700">R√©sultats attendus (‚â§ 100 mots)</label>
          <textarea rows="3" class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                    formControlName="expectedResults" placeholder="Changements mesurables attendus‚Ä¶"></textarea>
          <div class="text-xs text-red-600" *ngIf="stepObj.get('expectedResults')?.errors?.['wordLimit']">
            Max 100 mots (actuel : {{ stepObj.get('expectedResults')?.errors?.['wordLimit']?.actual }})
          </div>
        </div>

        <div class="grid gap-1 max-w-xs">
          <label class="text-sm font-medium text-gray-700">Dur√©e (mois)</label>
          <input type="number" min="1" max="48"
                 class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                 formControlName="durationMonths" placeholder="12">
        </div>
      </form>
    </div>

    <!-- 3) Activit√©s & calendrier -->
    <section class="card">
      <h2 class="card__title">Activit√©s principales & calendrier d‚Äôex√©cution</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="lbl">Date de d√©but du projet *</label>
          <input class="inp" type="date" formControlName="dateDebut">
        </div>
        <div>
          <label class="lbl">Date de fin du projet *</label>
          <input class="inp" type="date" formControlName="dateFin">
        </div>
      </div>

      <div class="mt-4">
        <label class="lbl">activit√©s principales (200 mots)</label>
        <textarea class="inp" rows="5" formControlName="principales"
                  placeholder="D√©crivez les grandes lignes des activit√©s..."></textarea>
      </div>

      <div class="mt-6">
        <div class="flex items-center justify-between mb-2">
          <label class="lbl">Calendrier d√©taill√© des activit√©s</label>
          <button type="button" class="btn btn--add" (click)="addActiviteRow()">Ôºã Ajouter</button>
        </div>

        <div *ngFor="let row of calendrier().controls; let i = index" [formGroup]="row" class="cal-row">
          <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
            <div class="md:col-span-7">
              <input class="inp" placeholder="Ex : Sensibilisation communautaire" formControlName="label">
            </div>
            <div class="md:col-span-2">
              <input class="inp" type="date" formControlName="debut">
            </div>
            <div class="md:col-span-2">
              <input class="inp" type="date" formControlName="fin">
            </div>
            <div class="md:col-span-1 flex justify-end">
              <button type="button" class="btn btn--danger" (click)="removeActiviteRow(i)">üóë</button>
            </div>
          </div>
        </div>
      </div>
    </section>


    <!-- 4) Risques -->
    <div *ngIf="current()===3" class="rounded-xl border bg-white p-5 md:p-6">
      <h2 class="text-lg font-semibold mb-4">Risques & mesures d‚Äôatt√©nuation</h2>

      <div class="flex items-center justify-between">
        <span></span>
        <button type="button" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-sm"
                (click)="addRisk()">Ajouter un risque</button>
      </div>

      <div class="mt-3 grid gap-4">
        <div class="rounded-xl border p-3"
             *ngFor="let r of risks.controls; let i = index; trackBy: trackByIndex"
             [formGroup]="r">
          <div class="grid gap-3 md:grid-cols-[1fr,1fr,auto] md:items-center">
            <div class="grid gap-1">
              <label class="text-sm font-medium text-gray-700">Description</label>
              <input class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                     formControlName="description" placeholder="Ex : Crues exceptionnelles‚Ä¶">
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium text-gray-700">Mesures d‚Äôatt√©nuation</label>
              <input class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                     formControlName="mitigation" placeholder="Ex : Phasage, dispositifs anti-crue‚Ä¶">
            </div>
            <button type="button" class="h-10 w-10 inline-grid place-items-center rounded-lg border border-red-200 text-red-600 hover:bg-red-50"
                    (click)="removeRisk(i)">üóë</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 5) Budget -->
    <div *ngIf="current()===4" class="rounded-xl border bg-white p-5 md:p-6">
      <h2 class="text-lg font-semibold mb-4">Budget estimatif</h2>
      <div class="flex items-center justify-between">
        <span></span>
        <button type="button" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-sm"
                (click)="addBudgetLine()">Ajouter une ligne</button>
      </div>

      <div class="mt-3 grid gap-4">
        <div class="rounded-xl border p-3"
             *ngFor="let b of budgetLines.controls; let i = index; trackBy: trackByIndex"
             [formGroup]="b">
          <div class="grid gap-3 md:grid-cols-5">
            <div class="grid gap-1">
              <label class="text-sm font-medium text-gray-700">Cat√©gorie</label>
              <select class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                      formControlName="category">
                <option value="ACTIVITES_TERRAIN">Activit√©s de terrain</option>
                <option value="INVESTISSEMENTS">Investissements</option>
                <option value="FONCTIONNEMENT">Fonctionnement</option>
              </select>
            </div>
            <div class="grid gap-1 md:col-span-2">
              <label class="text-sm font-medium text-gray-700">Description</label>
              <input class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                     formControlName="description">
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium text-gray-700">Total</label>
              <input type="number" min="0" class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                     formControlName="total">
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium text-gray-700">Part FPBG</label>
              <input type="number" min="0" class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                     formControlName="partFPBG">
            </div>
            <div class="grid gap-1">
              <label class="text-sm font-medium text-gray-700">Co-finance</label>
              <input type="number" min="0" class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                     formControlName="partCofinance">
            </div>
          </div>
          <div class="mt-1 text-xs text-red-600" *ngIf="b.errors?.['amountsMismatch']">La somme (FPBG + cofinancement) doit √©galer le Total.</div>
          <div class="mt-2">
            <button type="button" class="h-10 w-10 inline-grid place-items-center rounded-lg border border-red-200 text-red-600 hover:bg-red-50"
                    (click)="removeBudgetLine(i)">üóë</button>
          </div>
        </div>
      </div>

      <div class="mt-2 text-xs text-red-600" *ngIf="budgetError">Alerte : les lignes ¬´ Fonctionnement ¬ª d√©passent 10 % du total.</div>
    </div>

    <!-- 6) √âtat & financement -->
    <div *ngIf="current()===5" class="rounded-xl border bg-white p-5 md:p-6">
      <h2 class="text-lg font-semibold mb-4">√âtat d‚Äôavancement & financement</h2>
      <form [formGroup]="stateStep" class="grid gap-5">
        <div class="grid gap-1 max-w-md">
          <label class="text-sm font-medium text-gray-700">√âtat d‚Äôavancement</label>
          <select class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                  formControlName="projectStage">
            <option value="CONCEPTION">Conception</option>
            <option value="DEMARRAGE">D√©marrage</option>
            <option value="AVANCE">Avanc√©</option>
            <option value="PHASE_FINALE">Phase finale</option>
          </select>
        </div>
        <label class="inline-flex items-center gap-2 text-sm">
          <input type="checkbox" formControlName="hasFunding" class="h-4 w-4 rounded border-gray-300 text-green-600">
          Financement d√©j√† demand√©/obtenu ?
        </label>
        <div class="grid gap-1">
          <label class="text-sm font-medium text-gray-700">Pr√©cisez (bailleur, montant, statut‚Ä¶)</label>
          <textarea rows="3" class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                    formControlName="fundingDetails"></textarea>
        </div>
      </form>
    </div>

    <!-- 7) Durabilit√© & r√©plication -->
    <div *ngIf="current()===6" class="rounded-xl border bg-white p-5 md:p-6">
      <h2 class="text-lg font-semibold mb-4">Durabilit√© & potentiel de r√©plication</h2>
      <form [formGroup]="sustainabilityStep" class="grid gap-5">
        <div class="grid gap-1">
          <label class="text-sm font-medium text-gray-700">Durabilit√© (comment les effets perdurent ?)</label>
          <textarea rows="4" class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                    formControlName="sustainability"></textarea>
        </div>
        <div class="grid gap-1">
          <label class="text-sm font-medium text-gray-700">Potentiel de r√©plication (ailleurs au Gabon ?)</label>
          <textarea rows="4" class="block w-full rounded-xl border border-gray-300 bg-white px-3.5 py-2.5 text-[15px] shadow-sm"
                    formControlName="replicability"></textarea>
        </div>
      </form>
    </div>

    <!-- 8) Annexes -->
    <div *ngIf="current()===7" class="rounded-xl border bg-white p-5 md:p-6">
      <h2 class="text-lg font-semibold mb-4">Annexes</h2>
      <div class="grid gap-4 md:grid-cols-2">
        <ng-container *ngFor="let key of ['LETTRE_MOTIVATION','STATUTS_REGLEMENT','FICHE_CIRCUIT','RIB','AGREMENT','CV','BUDGET_DETAILLE','CHRONOGRAMME','CARTOGRAPHIE','LETTRE_SOUTIEN']; trackBy: trackByIndex">
          <div class="grid gap-1">
            <label class="text-sm font-medium text-gray-700">
              {{ key.replaceAll('_',' ') | lowercase }}
            </label>
            <input
              type="file"
              [attr.accept]="allowedAccept"
              class="block w-full text-sm text-gray-700 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border file:border-gray-300 file:bg-gray-50 hover:file:bg-gray-100"
              (change)="onFileChange($event, key)"
            >

          </div>
        </ng-container>
      </div>
    </div>

    <!-- 9) R√©capitulatif -->
    <div *ngIf="current()===8" class="rounded-xl border bg-white p-5 md:p-6">
      <h2 class="text-lg font-semibold mb-4">R√©capitulatif</h2>

      <div class="rounded-xl border p-3 mb-3">
        <strong>Titre :</strong> {{ stepProp.value.title }}<br>
        <strong>Domaines :</strong> {{ (stepProp.value.domains||[]).join(', ') || '‚Äî' }}<br>
        <strong>Lieu & groupe cible :</strong> {{ stepProp.value.locationAndTarget || '‚Äî' }}<br>
        <strong>Contexte :</strong> {{ stepProp.value.contextJustification || '‚Äî' }}
      </div>

      <div class="rounded-xl border p-3 mb-3">
        <strong>Objectifs :</strong> {{ stepObj.value.objectives || '‚Äî' }}<br>
        <strong>R√©sultats attendus :</strong> {{ stepObj.value.expectedResults || '‚Äî' }}<br>
        <strong>Dur√©e :</strong> {{ stepObj.value.durationMonths }} mois
      </div>

      <div class="rounded-xl border p-3 mb-3">
        <strong>R√©sum√© activit√©s :</strong> {{ activitiesSummary.value || '‚Äî' }}<br>
        <strong>Activit√©s :</strong>
        <ul class="list-disc ml-5">
          <li *ngFor="let a of activities.controls; trackBy: trackByIndex">
            {{ a.value.label }} ‚Äî Mois : {{ formatMonths(a.get('months')?.value) }}
          </li>
        </ul>
      </div>

      <div class="rounded-xl border p-3 mb-3">
        <strong>Budget :</strong>
        <ul class="list-disc ml-5">
          <li *ngFor="let b of budgetLines.controls; trackBy: trackByIndex">
            {{ b.get('category')?.value || '' }}
            ‚Äî {{ b.get('description')?.value || '' }}
            ‚Äî Total: {{ (b.get('total')?.value || 0) | number:'1.0-0' }}
          </li>
        </ul>
        <div class="text-xs text-red-600" *ngIf="budgetError">Alerte : ¬´ Fonctionnement ¬ª &gt; 10 %.</div>
      </div>

      <div class="rounded-xl border p-3 mb-3">
        <strong>√âtat :</strong> {{ stateStep.value.projectStage }}<br>
        <strong>Financement :</strong> {{ stateStep.value.hasFunding ? 'Oui' : 'Non' }} ‚Äî {{ stateStep.value.fundingDetails || '‚Äî' }}
      </div>

      <div class="rounded-xl border p-3 mb-3">
        <strong>Durabilit√© :</strong> {{ sustainabilityStep.value.sustainability || '‚Äî' }}<br>
        <strong>R√©plication :</strong> {{ sustainabilityStep.value.replicability || '‚Äî' }}
      </div>

      <div class="mt-3 flex gap-2">
        <button class="px-3 py-2 rounded-lg border hover:bg-slate-50" (click)="prev()">Retour</button>
        <button class="px-3 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700" (click)="submit()">Soumettre</button>
      </div>
    </div>

  </section>

  <!-- ===== Colonne Aide (droite) ===== -->
  <aside class="sticky top-4 h-max rounded-xl border bg-white p-5">
    <h3 class="text-base font-semibold mb-2">
      <span class="inline-block rounded-md bg-green-100 text-green-800 px-2 py-0.5 text-xs align-middle">Guide</span>
      {{ help[current()].title }}
    </h3>
    <div class="space-y-2 text-sm text-gray-700" [innerHTML]="help[current()].html"></div>

    <div class="mt-5 border-t pt-4">
      <h4 class="text-sm font-semibold mb-1 text-green-700">Conseils pratiques</h4>
      <div class="space-y-2 text-sm text-gray-700" [innerHTML]="adviceHtml"></div>
    </div>

    <div class="mt-5 border-t pt-4">
      <h4 class="text-sm font-semibold mb-1 text-green-700">S√©lection des dossiers</h4>
      <div class="space-y-2 text-sm text-gray-700" [innerHTML]="selectionHtml"></div>
    </div>
  </aside>
</div>
