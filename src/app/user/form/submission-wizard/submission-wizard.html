<!-- submission-wizard.html (corrig√©) -->
<div class="min-h-screen bg-slate-50 p-4 md:p-6">
  <div class="mx-auto max-w-7xl bg-white rounded-2xl shadow border border-slate-200 grid grid-cols-1 lg:grid-cols-[280px_1fr_320px] gap-6 p-4 md:p-6">

    <!-- √âtapes -->
    <aside class="lg:border-r lg:pr-6">
      <h3 class="text-xs font-semibold tracking-wide text-slate-500">PROGRESSION</h3>
      <div class="mt-2 h-2 rounded bg-slate-100">
        <div class="h-2 rounded bg-emerald-500 transition-all" [style.width.%]="progress()"></div>
      </div>

      <nav class="mt-4 space-y-1">
        <button *ngFor="let s of steps; let i = index; trackBy: trackByIndex"
                (click)="goTo(i)"
                class="w-full text-left px-3 py-2 rounded-md border flex items-center gap-2"
                [class.bg-emerald-600]="current()===i"
                [class.text-white]="current()===i"
                [class.border-emerald-600]="current()===i">
          <span class="text-sm">{{ i+1 }}. {{ s }}</span>
        </button>
      </nav>

      <div class="mt-6 flex gap-3">
        <button class="px-4 py-2 rounded-md border" (click)="prev()" [disabled]="current()===0">Retour</button>
        <button class="px-4 py-2 rounded-md bg-emerald-600 text-white disabled:opacity-50"
                (click)="next()" [disabled]="current()===(steps.length-1) || !canGoNext()">Suivant</button>
      </div>
    </aside>

    <!-- Formulaire -->
    <section class="min-h-[480px]">
      <!-- 1. Proposition -->
      <div *ngIf="current()===0" [formGroup]="prop" class="space-y-5">
        <h2 class="text-xl font-bold">Proposition de Projet</h2>

        <div>
          <label class="block text-sm font-medium mb-1">Titre du projet</label>
          <input type="text" class="w-full rounded-md border px-3 py-2" formControlName="title">
        </div>

        <div>
          <p class="text-xs text-slate-500 mb-1">Exemple : Restauration des mangroves de XXX ha‚Ä¶</p>
          <label class="block text-sm font-medium mb-2">Domaines d‚Äôintervention (s√©lectionnez un ou plusieurs)</label>
          <div class="grid sm:grid-cols-2 gap-3">
            <label *ngFor="let d of domaines" class="flex items-center gap-2 rounded-md border px-3 py-2">
              <input type="checkbox" (change)="toggleDomain(d, $event)">
              <span class="text-sm">{{ d }}</span>
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Lieu d‚Äôex√©cution & groupe cible (‚â§ 200 mots)</label>
          <textarea rows="4" class="w-full rounded-md border px-3 py-2" formControlName="locationAndTarget"></textarea>
          <p *ngIf="prop.get('locationAndTarget')?.errors?.['wordLimit']" class="text-xs text-red-600 mt-1">
            Limite d√©pass√©e ({{prop.get('locationAndTarget')?.errors?.['wordLimit'].actual}} / {{prop.get('locationAndTarget')?.errors?.['wordLimit'].max}} mots)
          </p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Contexte & justification (‚â§ 500 mots)</label>
          <textarea rows="6" class="w-full rounded-md border px-3 py-2" formControlName="contextJustification"></textarea>
          <p *ngIf="prop.get('contextJustification')?.errors?.['wordLimit']" class="text-xs text-red-600 mt-1">
            Limite d√©pass√©e ({{prop.get('contextJustification')?.errors?.['wordLimit'].actual}} / {{prop.get('contextJustification')?.errors?.['wordLimit'].max}} mots)
          </p>
        </div>
      </div>

      <!-- 2. Objectifs & r√©sultats -->
      <div *ngIf="current()===1" [formGroup]="obj" class="space-y-5">
        <h2 class="text-xl font-bold">Objectifs du projet & R√©sultats</h2>

        <div>
          <label class="block text-sm font-medium mb-1">Objectifs (‚â§ 200 mots)</label>
          <textarea rows="5" class="w-full rounded-md border px-3 py-2" formControlName="objectives" placeholder="Formulez des objectifs SMART..."></textarea>
          <p *ngIf="obj.get('objectives')?.errors?.['wordLimit']" class="text-xs text-red-600 mt-1">
            Limite d√©pass√©e ({{obj.get('objectives')?.errors?.['wordLimit'].actual}} / {{obj.get('objectives')?.errors?.['wordLimit'].max}}).
          </p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">R√©sultats attendus (‚â§ 100 mots)</label>
          <textarea rows="4" class="w-full rounded-md border px-3 py-2" formControlName="expectedResults" placeholder="Changements mesurables attendus..."></textarea>
          <p *ngIf="obj.get('expectedResults')?.errors?.['wordLimit']" class="text-xs text-red-600 mt-1">
            Limite d√©pass√©e ({{obj.get('expectedResults')?.errors?.['wordLimit'].actual}} / {{obj.get('expectedResults')?.errors?.['wordLimit'].max}}).
          </p>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Dur√©e (mois)</label>
          <input type="number" min="1" class="w-40 rounded-md border px-3 py-2" formControlName="durationMonths">
        </div>
      </div>

      <!-- 3. Activit√©s & calendrier -->
      <div *ngIf="current()===2" class="space-y-5">
        <h2 class="text-xl font-bold">Activit√©s principales & calendrier d‚Äôex√©cution</h2>

        <div [formGroup]="activitiesHeader" class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Date de d√©but du projet *</label>
            <input type="date" class="w-full rounded-md border px-3 py-2" formControlName="startDate">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Date de fin du projet *</label>
            <input type="date" class="w-full rounded-md border px-3 py-2" formControlName="endDate">
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm font-medium mb-1">Activit√©s principales (‚â§ 200 mots)</label>
            <textarea rows="4" class="w-full rounded-md border px-3 py-2" formControlName="summary"
                      placeholder="D√©crivez les grandes lignes des activit√©s..."></textarea>
            <p *ngIf="activitiesHeader.get('summary')?.errors?.['wordLimit']" class="text-xs text-red-600 mt-1">
              Limite d√©pass√©e ({{activitiesHeader.get('summary')?.errors?.['wordLimit'].actual}} / {{activitiesHeader.get('summary')?.errors?.['wordLimit'].max}}).
            </p>
          </div>
        </div>

        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Calendrier d√©taill√© des activit√©s</h3>
          <button type="button" class="px-3 py-1.5 rounded-md bg-emerald-600 text-white" (click)="addActivity()">+ Ajouter</button>
        </div>

        <div class="space-y-3">
          <div *ngFor="let a of activities.controls; let i = index; trackBy: trackByIndex"
               [formGroup]="a"
               class="rounded-lg border p-3 grid md:grid-cols-[1fr_200px_200px_40px] gap-3 items-end">
            <div>
              <label class="block text-xs font-medium mb-1">Libell√©</label>
              <input type="text" class="w-full rounded-md border px-3 py-2" formControlName="label" placeholder="Ex : Sensibilisation communautaire">
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Date d√©but *</label>
              <input type="date" class="w-full rounded-md border px-3 py-2" formControlName="start">
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Date fin *</label>
              <input type="date" class="w-full rounded-md border px-3 py-2" formControlName="end">
            </div>
            <div class="flex justify-end">
              <button type="button" class="px-2 py-2 rounded-md border text-red-600" (click)="removeActivity(i)">üóë</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. Risques -->
      <div *ngIf="current()===3" class="space-y-5">
        <h2 class="text-xl font-bold">Risques & mesures d‚Äôatt√©nuation</h2>

        <div class="flex justify-end">
          <button type="button" class="px-3 py-1.5 rounded-md bg-emerald-600 text-white" (click)="addRisk()">Ajouter un risque</button>
        </div>

        <div class="space-y-3">
          <div *ngFor="let r of risks.controls; let i = index; trackBy: trackByIndex"
               [formGroup]="r"
               class="rounded-lg border p-3 grid md:grid-cols-[1fr_1fr_44px] gap-3 items-end">
            <div>
              <label class="block text-xs font-medium mb-1">Description</label>
              <input type="text" class="w-full rounded-md border px-3 py-2" formControlName="description" placeholder="Ex : Crues exceptionnelles, blocage">
            </div>
            <div>
              <label class="block text-xs font-medium mb-1">Mesures d‚Äôatt√©nuation</label>
              <input type="text" class="w-full rounded-md border px-3 py-2" formControlName="mitigation" placeholder="Ex : Phasage, dispositifs anti-crue, ...">
            </div>
            <div class="flex justify-end">
              <button type="button" class="px-2 py-2 rounded-md border text-red-600" (click)="removeRisk(i)">üóë</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 5. Budget -->
      <div *ngIf="current()===4" [formGroup]="budget" class="space-y-5">
        <h2 class="text-xl font-bold">Budget estimatif</h2>

        <div class="rounded-lg border p-3 bg-sky-50 text-sm">Fourchette autoris√©e: <b>5 000 000 ‚Äì 50 000 000 FCFA</b></div>

        <div>
          <label class="block text-sm font-medium mb-1">Activit√©s de terrain (FCFA)</label>
          <input type="number" min="0" class="w-full rounded-md border px-3 py-2" formControlName="terrain">
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Investissements (FCFA)</label>
          <input type="number" min="0" class="w-full rounded-md border px-3 py-2" formControlName="invest">
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Fonctionnement (FCFA)</label>
          <input type="number" min="0" class="w-full rounded-md border px-3 py-2" formControlName="overhead">
          <p *ngIf="overheadTooHigh()" class="text-xs text-red-600 mt-1">Les frais de fonctionnement d√©passent 10% du total.</p>
        </div>

        <div class="rounded-lg border p-3 bg-emerald-50 flex items-center justify-between">
          <div class="font-semibold">Total du projet</div>
          <div class="text-lg font-bold">{{ totalBudget() | number:'1.0-0' }} FCFA</div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Part cofinanceur (si applicable, en FCFA)</label>
          <input type="number" min="0" class="w-full rounded-md border px-3 py-2" formControlName="cofin">
          <p class="text-xs text-slate-500 mt-1">Non obligatoire mais encourag√©e</p>
        </div>
      </div>

      <!-- 6. √âtat & financement -->
      <div *ngIf="current()===5" [formGroup]="projectState" class="space-y-5">
        <h2 class="text-xl font-bold">√âtat d‚Äôavancement du projet</h2>

        <div class="space-y-2">
          <label class="flex items-center gap-3 rounded-lg border px-3 py-2">
            <input type="radio" formControlName="stage" [value]="'CONCEPTION'"> Conception
          </label>
          <label class="flex items-center gap-3 rounded-lg border px-3 py-2">
            <input type="radio" formControlName="stage" [value]="'DEMARRAGE'"> D√©marrage
          </label>
          <label class="flex items-center gap-3 rounded-lg border px-3 py-2">
            <input type="radio" formControlName="stage" [value]="'AVANCE'"> Avanc√©
          </label>
          <label class="flex items-center gap-3 rounded-lg border px-3 py-2">
            <input type="radio" formControlName="stage" [value]="'PHASE_FINALE'"> Phase finale
          </label>
        </div>

        <div class="mt-4">
          <p class="font-medium mb-2">Avez-vous d√©j√† demand√© / obtenu un financement pour ce projet ?</p>
          <div class="flex items-center gap-6">
            <label class="flex items-center gap-2">
              <input type="radio" formControlName="hasFunding" [value]="false"> Non
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" formControlName="hasFunding" [value]="true"> Oui
            </label>
          </div>

          <textarea *ngIf="projectState.get('hasFunding')?.value" rows="4" class="mt-3 w-full rounded-md border px-3 py-2"
                    formControlName="fundingDetails" placeholder="Pr√©cisez les d√©tails..."></textarea>
        </div>
      </div>

      <!-- 7. Durabilit√© & r√©plication -->
      <div *ngIf="current()===6" [formGroup]="sustainability" class="space-y-5">
        <h2 class="text-xl font-bold">Durabilit√© et potentiel de r√©plication</h2>

        <label class="block text-sm font-medium mb-1">D√©crivez la durabilit√© et le potentiel de r√©plication (‚â§ 250 mots)</label>
        <textarea rows="6" class="w-full rounded-md border px-3 py-2" formControlName="text"
                  placeholder="Quels impacts positifs du projet se p√©renniseront ? Le projet est-il r√©plicable ailleurs au Gabon ?"></textarea>
        <p *ngIf="sustainability.get('text')?.errors?.['wordLimit']" class="text-xs text-red-600 mt-1">
          Limite d√©pass√©e ({{sustainability.get('text')?.errors?.['wordLimit'].actual}} / {{sustainability.get('text')?.errors?.['wordLimit'].max}}).
        </p>

        <div class="rounded-lg border p-3 bg-emerald-50">
          <h4 class="font-semibold mb-1">Points √† consid√©rer :</h4>
          <ul class="list-disc ml-5 space-y-0.5">
            <li>Impacts environnementaux durables</li>
            <li>Renforcement des capacit√©s locales</li>
            <li>Mod√®le √©conomique viable</li>
            <li>Appropriation communautaire</li>
            <li>Transf√©rabilit√© √† d‚Äôautres zones</li>
          </ul>
        </div>
      </div>

      <!-- 8. Annexes -->
      <div *ngIf="current()===7" [formGroup]="attachments" class="space-y-5">
        <h2 class="text-xl font-bold">Annexes</h2>

        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Lettre de motivation</label>
            <input type="file" [accept]="allowedAccept" (change)="onFile($event, 'LETTRE_MOTIVATION')" class="block w-full text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Statuts & r√®glement</label>
            <input type="file" [accept]="allowedAccept" (change)="onFile($event, 'STATUTS_REGLEMENT')" class="block w-full text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Fiche circuit (PME/PMI/Startup)</label>
            <input type="file" [accept]="allowedAccept" (change)="onFile($event, 'FICHE_CIRCUIT')" class="block w-full text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">C√îTE</label>
            <input type="file" [accept]="allowedAccept" (change)="onFile($event, 'COTE')" class="block w-full text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Agr√©ment / R√©c√©piss√©</label>
            <input type="file" [accept]="allowedAccept" (change)="onFile($event, 'AGREMENT')" class="block w-full text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">CV (porteur & responsables)</label>
            <input type="file" [accept]="allowedAccept" (change)="onFile($event, 'CV')" class="block w-full text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Budget d√©taill√©</label>
            <input type="file" [accept]="allowedAccept" (change)="onFile($event, 'BUDGET_DETAILLE')" class="block w-full text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Chronogramme</label>
            <input type="file" [accept]="allowedAccept" (change)="onFile($event, 'CHRONOGRAMME')" class="block w-full text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Cartographie (optionnel)</label>
            <input type="file" [accept]="allowedAccept" (change)="onFile($event, 'CARTOGRAPHIE')" class="block w-full text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Lettre de soutien (optionnel)</label>
            <input type="file" [accept]="allowedAccept" (change)="onFile($event, 'LETTRE_SOUTIEN')" class="block w-full text-sm">
          </div>
        </div>
      </div>

      <!-- 9. R√©capitulatif -->
      <div *ngIf="current()===8" class="space-y-5">
        <h2 class="text-xl font-bold">R√©capitulatif</h2>

        <div class="space-y-3">
          <div class="rounded-lg border p-3">
            <div class="font-semibold">Titre :</div>
            <div class="text-sm">{{ form.value.prop?.title || '‚Äî' }}</div>
          </div>

          <div class="rounded-lg border p-3">
            <div class="font-semibold">Lieu & groupe cible :</div>
            <div class="text-sm whitespace-pre-wrap">{{ form.value.prop?.locationAndTarget || '‚Äî' }}</div>
          </div>

          <div class="rounded-lg border p-3">
            <div class="font-semibold">Contexte :</div>
            <div class="text-sm whitespace-pre-wrap">{{ form.value.prop?.contextJustification || '‚Äî' }}</div>
          </div>

          <div class="rounded-lg border p-3">
            <div class="font-semibold">Objectifs :</div>
            <div class="text-sm whitespace-pre-wrap">{{ form.value.obj?.objectives || '‚Äî' }}</div>
          </div>

          <div class="rounded-lg border p-3">
            <div class="font-semibold">R√©sultats attendus :</div>
            <div class="text-sm whitespace-pre-wrap">{{ form.value.obj?.expectedResults || '‚Äî' }}</div>
          </div>

          <div class="rounded-lg border p-3">
            <div class="font-semibold">Dur√©e :</div>
            <div class="text-sm">{{ form.value.obj?.durationMonths || 0 }} mois</div>
          </div>

          <div class="rounded-lg border p-3">
            <div class="font-semibold">R√©sum√© activit√©s :</div>
            <div class="text-sm whitespace-pre-wrap">{{ form.value.activitiesHeader?.summary || '‚Äî' }}</div>
            <div class="mt-2 font-semibold">Activit√©s :</div>
            <ul class="list-disc ml-5 text-sm">
              <li *ngFor="let a of activities.controls; trackBy: trackByIndex">
                {{ a.value['label'] }} ‚Äî du {{ a.value['start'] }} au {{ a.value['end'] }}
              </li>
            </ul>
          </div>

          <div class="rounded-lg border p-3">
            <div class="font-semibold">Budget :</div>
            <ul class="list-disc ml-5 text-sm">
              <li>Activit√©s de terrain ‚Äî {{ budget.get('terrain')?.value || 0 | number:'1.0-0' }} FCFA</li>
              <li>Investissements ‚Äî {{ budget.get('invest')?.value || 0 | number:'1.0-0' }} FCFA</li>
              <li>Fonctionnement ‚Äî {{ budget.get('overhead')?.value || 0 | number:'1.0-0' }} FCFA</li>
              <li class="font-semibold mt-1">Total ‚Äî {{ totalBudget() | number:'1.0-0' }} FCFA</li>
              <li *ngIf="budget.get('cofin')?.value">Cofinanceur ‚Äî {{ budget.get('cofin')?.value | number:'1.0-0' }} FCFA</li>
            </ul>
          </div>

          <div class="rounded-lg border p-3">
            <div class="font-semibold">√âtat :</div>
            <div class="text-sm">
              {{ projectState.get('stage')?.value === 'CONCEPTION' ? 'CONCEPTION'
              : projectState.get('stage')?.value === 'DEMARRAGE' ? 'D√âMARRAGE'
                : projectState.get('stage')?.value === 'AVANCE' ? 'AVANC√â'
                  : 'PHASE FINALE' }}
            </div>
            <div class="font-semibold mt-2">Financement :</div>
            <div class="text-sm">
              {{ projectState.get('hasFunding')?.value ? ('Oui ‚Äî ' + (projectState.get('fundingDetails')?.value || '')) : 'Non' }}
            </div>
          </div>

          <div class="rounded-lg border p-3">
            <div class="font-semibold">Durabilit√© / R√©plication :</div>
            <div class="text-sm whitespace-pre-wrap">{{ sustainability.get('text')?.value || '‚Äî' }}</div>
          </div>

          <div class="rounded-lg border p-3">
            <div class="font-semibold">Annexes :</div>
            <ul class="list-disc ml-5 text-sm">
              <li *ngFor="let k of (attachments.controls | keyvalue)">
                {{ k.key }} ‚Äî
                <ng-container *ngIf="attachments.get(k.key)?.value as f; else none">
                  {{ f?.name }} ({{ (f?.size || 0) | number:'1.0-0' }} o)
                </ng-container>
                <ng-template #none> Aucun fichier </ng-template>
              </li>
            </ul>
          </div>
        </div>

        <div class="flex gap-3 pt-2">
          <button class="px-4 py-2 rounded-md border" (click)="prev()">Retour</button>
          <button class="px-4 py-2 rounded-md bg-emerald-600 text-white" (click)="submit()">Soumettre</button>
        </div>
      </div>
    </section>

    <!-- Guide -->
    <aside class="lg:border-l lg:pl-6">
      <div class="sticky top-4 space-y-4">
        <div class="rounded-xl border bg-white p-4">
          <div [innerHTML]="guideHtml[current()]"></div>
        </div>
        <div class="rounded-xl border bg-white p-4">
          <h4 class="font-semibold text-emerald-700 mb-1">Conseils pratiques</h4>
          <ul class="list-disc ml-5 space-y-1">
            <li><b>Soyez clair et concis</b> : allez √† l‚Äôessentiel pour susciter l‚Äôint√©r√™t.</li>
            <li><b>Impact</b> : mettez en avant les b√©n√©fices concrets.</li>
            <li><b>Alignement</b> : coh√©rence avec les objectifs/priorit√©s FPBG et les appels en cours.</li>
            <li><b>Professionnalisme</b> : respect des limites de mots, chiffres v√©rifi√©s.</li>
          </ul>
          <hr class="my-3">
          <div [innerHTML]="conseilsHtml[current()]"></div>
        </div>
      </div>
    </aside>

  </div>
</div>
