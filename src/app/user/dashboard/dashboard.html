<!-- USER DASHBOARD — FPBG (vue utilisateur) -->
<!-- Toggler mobile -->
<div class="mb-4 md:hidden flex items-center justify-between">
  <button class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50" (click)="toggleAside()">
    {{ asideOpen() ? 'Fermer' : 'Menu' }}
  </button>
</div>

<div class="relative grid gap-6 md:grid-cols-[280px,1fr]">
  <!-- Overlay mobile -->
  <div *ngIf="asideOpen()" class="fixed inset-0 z-40 bg-black/40 md:hidden" (click)="toggleAside()"></div>

  <!-- ===== SIDEBAR épurée ===== -->
  <aside
    class="fixed inset-y-0 left-0 z-50 w-[86%] max-w-xs bg-[#0B1F2C] text-white shadow-xl
         transition-transform duration-200 ease-out md:static md:z-0
         md:w-auto md:max-w-none md:border md:border-slate-800 md:shadow-sm
         lg:sticky lg:top-0 lg:self-start lg:min-h-screen lg:overflow-y-auto
         md:translate-x-0"
    [class.-translate-x-full]="!asideOpen()">

    <!-- bande verte en haut -->
    <div class="h-1 w-full bg-green-500"></div>

    <!-- header mobile -->
    <div class="md:hidden px-4 py-3 border-b border-white/10 flex justify-end">
      <button class="text-white/70" (click)="toggleAside()">✕</button>
    </div>

    <div class="flex flex-col h-full">
      <!-- Profil + statut + CTA -->
      <div class="p-6 border-b border-slate-800">
        <div class="flex flex-col items-center text-center gap-3">
          <ng-container *ngIf="!imgError(); else fallbackAvatar">
            <img [src]="user().photoUrl" (error)="imgError.set(true)" alt="Photo"
                 class="h-20 w-20 rounded-md object-cover ring-2 ring-green-400/60">
          </ng-container>
          <ng-template #fallbackAvatar>
            <div class="h-20 w-20 rounded-md grid place-items-center bg-white/10 ring-2 ring-green-400/60 text-2xl font-semibold">
              {{ initials() }}
            </div>
          </ng-template>

          <div class="min-w-0">
            <p class="text-[10px] uppercase tracking-wider text-green-300/90">Porteur de projet</p>
            <h3 class="mt-1 font-semibold text-green-300 leading-snug break-words">
              {{ user().fullName }}
            </h3>
          </div>

          <div class="mt-2">
            <span *ngIf="hasProject(); else noProject"
                  class="rounded-full px-2 py-0.5 text-xs"
                  [class]="statusClass()">
              {{ status() }}
            </span>
            <ng-template #noProject>
              <span class="rounded-full px-2 py-0.5 text-xs bg-slate-200 text-slate-800">Aucun projet</span>
            </ng-template>
          </div>

          <!-- CTA principal (vert) -->
          <button class="mt-4 w-full px-3 py-2 rounded-md bg-green-600 hover:bg-green-700 text-white font-medium"
                  (click)="primaryActionClick()">
            {{ ctaLabel() }}
          </button>

          <!-- CTA secondaire -->
          <button class="w-full px-3 py-2 rounded-md border border-green-400/60 text-green-200
                       bg-white/0 hover:bg-green-500/10"
                  *ngIf="hasProject()"
                  (click)="showAddCollaborator.set(true); scrollTo('collab')">
            Ajouter un collaborateur
          </button>
        </div>
      </div>

      <!-- Menu minimal -->
      <nav class="p-2 text-sm flex-1 overflow-y-auto">
        <!-- ⚠️ Aperçu -> redirige vers la page recap -->
        <a (click)="goRecap()"
           class="block px-3 py-2 hover:bg-green-500/10 hover:border-l-4 hover:border-green-500 cursor-pointer">
          Aperçu
        </a>
        <a (click)="primaryActionClick()"
           class="block px-3 py-2 hover:bg-green-500/10 hover:border-l-4 hover:border-green-500 cursor-pointer">
          Mon projet
        </a>
        <a (click)="scrollTo('collab')"
           class="block px-3 py-2 hover:bg-green-500/10 hover:border-l-4 hover:border-green-500 cursor-pointer">
          Collaborateurs
        </a>
        <a href="mailto:contact@fpbg.ga"
           class="block px-3 py-2 hover:bg-green-500/10 hover:border-l-4 hover:border-green-500 cursor-pointer">
          Aide & support
        </a>
      </nav>

      <!-- Déconnexion -->
      <div class="mt-auto p-2 border-t border-slate-800">
        <button class="w-full text-left px-3 py-2 hover:bg-green-500/10" (click)="logout()">
          Se déconnecter
        </button>
      </div>
    </div>
  </aside>

  <!-- ===== MAIN ===== -->
  <section class="min-h-[60vh]">
    <!-- Aperçu local (header) -->
    <div id="overview" class="mb-4">
      <h1 class="text-xl sm:text-2xl font-semibold text-slate-900">Tableau de bord</h1>
      <p class="text-slate-600">Votre espace projet FPBG.</p>
    </div>

    <!-- Stats -->
    <div class="grid gap-4 sm:grid-cols-3">
      <div class="rounded-xl border bg-white p-5">
        <p class="text-sm text-gray-600">Projet</p>
        <p class="mt-1 text-2xl font-semibold">{{ hasProject() ? 1 : 0 }}</p>
      </div>
      <div class="rounded-xl border bg-white p-5">
        <p class="text-sm text-gray-600">Statut</p>
        <p class="mt-1 text-2xl font-semibold">{{ status() ? status() : '—' }}</p>
      </div>
      <div class="rounded-xl border bg-white p-5">
        <p class="text-sm text-gray-600">Dernière mise à jour</p>
        <p class="mt-1 text-2xl font-semibold">
          {{ submission()?.updatedAt ? (submission()?.updatedAt | date:'short') : '—' }}
        </p>
      </div>
    </div>

    <!-- Actions contextuelles -->
    <div class="mt-6 grid gap-4 md:grid-cols-2">
      <!-- Aucun projet -->
      <div class="rounded-xl border bg-white p-6" *ngIf="!hasProject()">
        <h2 class="text-lg font-medium">Démarrer votre projet</h2>
        <p class="mt-1 text-gray-600">Un seul projet par compte. Vous pourrez reprendre à tout moment.</p>
        <div class="mt-4">
          <button class="btn-primary" (click)="startProject()">Créer votre projet</button>
        </div>
      </div>

      <!-- Brouillon -->
      <div class="rounded-xl border bg-white p-6" *ngIf="isDraft()">
        <h2 class="text-lg font-medium">Continuer votre brouillon</h2>
        <p class="mt-1 text-gray-600">Le formulaire se rouvrira à l’étape où vous vous êtes arrêté.</p>
        <div class="mt-4 flex gap-2">
          <button class="btn-primary" (click)="resumeDraft()">Continuer</button>
          <button class="btn px-4 py-2 border" (click)="clearDraftOnly()">Réinitialiser le brouillon</button>
        </div>
      </div>

      <!-- Projet soumis/en revue -->
      <div class="rounded-xl border bg-white p-6" *ngIf="hasProject() && !isDraft()">
        <h2 class="text-lg font-medium">Votre projet</h2>
        <p class="mt-1 text-gray-600">Statut : <strong>{{ status() }}</strong></p>
        <div class="mt-4 flex gap-2">
          <!-- ⚠️ Voir le récap -> /recap -->
          <button class="btn px-4 py-2 border" (click)="goRecap()">Voir le récapitulatif</button>
          <button class="btn px-4 py-2 border" (click)="submitProjectMock()" *ngIf="status() === 'BROUILLON'">
            Soumettre (démo)
          </button>
        </div>
      </div>
    </div>

    <!-- Collaborateurs -->
    <div id="collab" class="mt-6 rounded-xl border bg-white p-6" *ngIf="hasProject()">
      <div class="flex items-center justify-between gap-4">
        <h2 class="text-lg font-medium">Collaborateurs</h2>
        <button class="btn px-4 py-2 border" (click)="showAddCollaborator.set(true)">Ajouter</button>
      </div>

      <div class="mt-4" *ngIf="collaborators().length; else emptyCollab">
        <ul class="divide-y rounded-xl border">
          <li *ngFor="let c of collaborators()" class="p-3 flex items-center justify-between">
            <div>
              <p class="font-medium">{{ c.fullName }}</p>
              <p class="text-xs text-gray-600">{{ c.email }}</p>
            </div>
            <span class="text-xs bg-gray-100 px-2 py-0.5 rounded-full">{{ c.role }}</span>
          </li>
        </ul>
      </div>
      <ng-template #emptyCollab>
        <p class="text-sm text-gray-600">Aucun collaborateur pour le moment.</p>
      </ng-template>

      <!-- Dialog inline -->
      <div class="mt-6 rounded-lg border bg-slate-50 p-4" *ngIf="showAddCollaborator()">
        <form class="grid gap-4 md:grid-cols-3" [formGroup]="collabForm" (ngSubmit)="addCollaborator()">
          <div>
            <label class="block text-sm mb-1">Nom complet</label>
            <input class="w-full rounded-md border px-3 py-2 bg-white
                    focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                   formControlName="fullName" placeholder="Nom Prénom">
          </div>
          <div>
            <label class="block text-sm mb-1">Email</label>
            <input class="w-full rounded-md border px-3 py-2 bg-white
                    focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                   formControlName="email" placeholder="nom@domaine.com">
          </div>
          <div>
            <label class="block text-sm mb-1">Rôle</label>
            <select class="w-full rounded-md border px-3 py-2 bg-white
                     focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                    formControlName="role">
              <option>Éditeur</option>
              <option>Lecteur</option>
              <option>Admin projet</option>
            </select>
          </div>

          <div class="md:col-span-3 flex gap-2">
            <button class="rounded-md bg-green-600 hover:bg-green-700 text-white px-4 py-2" type="submit">
              Ajouter
            </button>
            <button type="button" class="rounded-md border px-4 py-2 hover:bg-slate-100"
                    (click)="showAddCollaborator.set(false)">
              Annuler
            </button>
          </div>
        </form>
      </div>
    </div>
  </section>
</div>
